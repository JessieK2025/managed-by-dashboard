<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThreeFlow Managed Pilot Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Lato', sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        .header {
            background: white;
            border-bottom: 4px solid #00B980;
            padding: 32px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #000099;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .broker-select, .csv-upload {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            font-family: 'Lato', sans-serif;
            font-size: 14px;
            color: #374151;
            min-width: 200px;
        }
        
        .broker-select:focus, .csv-upload:focus {
            outline: none;
            border-color: #00B980;
        }
        
        .renewal-multi-select {
            position: relative;
            min-width: 250px;
        }
        
        .renewal-select-button {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            font-family: 'Lato', sans-serif;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            text-align: left;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .renewal-select-button:hover {
            border-color: #00B980;
        }
        
        .renewal-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #00B980;
            border-radius: 8px;
            z-index: 1000;
            display: none;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .renewal-dropdown.show {
            display: block;
        }
        
        .renewal-option {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .renewal-option:last-child {
            border-bottom: none;
        }
        
        .renewal-option:hover {
            background-color: #f0f9ff;
        }
        
        .renewal-option input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }
        
        .renewal-option-label {
            cursor: pointer;
            flex: 1;
            font-size: 14px;
        }
        
        .upload-btn {
            background: #00B980;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-family: 'Lato', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .upload-btn:hover {
            background: #1A7848;
        }
        
        .upload-status {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }
        
        .upload-status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .upload-status.error {
            background: #fecaca;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        
        /* Repeatable Carriers Alert Section */
        .repeatable-carriers-section {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid #f87171;
            border-radius: 16px;
            padding: 32px;
            margin: 40px 0;
        }
        
        .repeatable-carriers-title {
            color: #991b1b;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
        }
        
        .carrier-alert-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .carrier-alert-item {
            background: rgba(255,255,255,0.8);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #ef4444;
            transition: transform 0.2s ease;
        }
        
        .carrier-alert-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239,68,68,0.2);
        }
        
        .carrier-alert-item.escalated {
            border-left-color: #dc2626;
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
        }
        
        .carrier-alert-item.not-started {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }
        
        .carrier-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .carrier-issues {
            font-size: 0.95rem;
            color: #374151;
            margin-bottom: 12px;
        }
        
        .carrier-details {
            display: flex;
            gap: 16px;
            font-size: 0.875rem;
        }
        
        .issue-count {
            background: rgba(255,255,255,0.8);
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .issue-count.escalated {
            color: #dc2626;
            border: 1px solid #f87171;
        }
        
        .issue-count.not-started {
            color: #d97706;
            border: 1px solid #fbbf24;
        }
        
        .no-issues {
            text-align: center;
            color: #059669;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 40px;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-radius: 12px;
            border: 2px solid #10b981;
        }
        
        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 32px 0;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 6px solid;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .metric-card.primary { border-left-color: #00B980; }
        .metric-card.success { border-left-color: #1A7848; }
        .metric-card.secondary { border-left-color: #000099; }
        .metric-card.purple { border-left-color: #8A288E; }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .metric-icon.primary { background-color: #00B980; }
        .metric-icon.success { background-color: #1A7848; }
        .metric-icon.secondary { background-color: #000099; }
        .metric-icon.purple { background-color: #8A288E; }
        
        .metric-title {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .metric-subtitle {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        /* Insights Section */
        .insights-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            border: 2px solid #f59e0b;
            border-radius: 16px;
            padding: 32px;
            margin: 40px 0;
        }
        
        .insights-title {
            color: #92400e;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 32px;
        }
        
        .insights-column h4 {
            color: #1f2937;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 16px;
        }
        
        .insights-column ul {
            list-style: none;
        }
        
        .insights-column li {
            color: #374151;
            margin-bottom: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.5);
            border-radius: 6px;
            font-size: 0.95rem;
        }
        
        /* Broker Performance */
        .brokers-section {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 40px 0;
        }
        
        .section-title {
            color: #000099;
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 32px;
            border-bottom: 3px solid #00B980;
            padding-bottom: 16px;
        }
        
        .broker-item {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .broker-item:hover {
            border-color: #00B980;
            box-shadow: 0 4px 12px rgba(0,185,128,0.15);
        }
        
        .broker-header {
            padding: 24px;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .broker-info h3 {
            font-weight: 700;
            font-size: 1.25rem;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .broker-stats {
            color: #6b7280;
            font-size: 0.95rem;
            margin-bottom: 12px;
        }
        
        .progress-container {
            width: 100%;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00B980 0%, #1A7848 100%);
            border-radius: 5px;
            transition: width 0.8s ease;
        }
        
        .completion-rate {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
        }
        
        .completion-rate.high { color: #1A7848; }
        .completion-rate.medium { color: #D7CC43; }
        .completion-rate.low { color: #ef4444; }
        
        .broker-details {
            padding: 24px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: none;
        }
        
        .broker-details.expanded {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }
        
        .detail-item {
            text-align: center;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .detail-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .detail-label {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .detail-item.complete .detail-value { color: #1A7848; }
        .detail-item.pending .detail-value { color: #D7CC43; }
        .detail-item.escalated .detail-value { color: #ef4444; }
        .detail-item.carriers .detail-value { color: #8A288E; }
        
        .chevron {
            transition: transform 0.3s ease;
            color: #6b7280;
        }
        
        .chevron.expanded {
            transform: rotate(90deg);
        }
        
        /* Footer */
        .footer {
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 32px 0;
            margin-top: 48px;
            text-align: center;
            color: #6b7280;
        }
        
        .threeflow-brand {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
        }
        
        .brand-dot {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #00B980 0%, #1A7848 100%);
            border-radius: 50%;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .metrics-grid { grid-template-columns: 1fr; }
            .insights-grid { grid-template-columns: 1fr; }
            .broker-header { flex-direction: column; text-align: center; gap: 16px; }
            .details-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <h1>Managed by Three Flow Pilot</h1>
            <p>Document Collection Progress Dashboard</p>
            <div class="header-controls">
                <input type="file" id="csvFile" accept=".csv" class="csv-upload" />
                <button onclick="uploadCSV()" class="upload-btn">Upload New CSV</button>
                <div id="uploadStatus" class="upload-status"></div>
                
                <select class="broker-select" id="brokerSelect">
                    <option value="all">All Brokers</option>
                </select>
                
                <div class="renewal-multi-select">
                    <div class="renewal-select-button" onclick="toggleRenewalDropdown(event)">
                        <span id="renewalButtonText">All Renewal Dates</span>
                        <span>‚ñº</span>
                    </div>
                    <div class="renewal-dropdown" id="renewalDropdown">
                        <div class="renewal-option" onclick="toggleRenewalOption(event, 'all-renewals')">
                            <input type="checkbox" id="all-renewals" value="all" checked>
                            <span class="renewal-option-label">All Renewal Dates</span>
                        </div>
                        <div class="renewal-option" onclick="toggleRenewalOption(event, 'oct-1-25')">
                            <input type="checkbox" id="oct-1-25" value="october-1-2025">
                            <span class="renewal-option-label">October 1, 2025</span>
                        </div>
                        <div class="renewal-option" onclick="toggleRenewalOption(event, 'nov-1-25')">
                            <input type="checkbox" id="nov-1-25" value="november-1-2025">
                            <span class="renewal-option-label">November 1, 2025</span>
                        </div>
                        <div class="renewal-option" onclick="toggleRenewalOption(event, 'dec-1-25')">
                            <input type="checkbox" id="dec-1-25" value="december-1-2025">
                            <span class="renewal-option-label">December 1, 2025</span>
                        </div>
                        <div class="renewal-option" onclick="toggleRenewalOption(event, 'jan-1-26')">
                            <input type="checkbox" id="jan-1-26" value="january-1-2026">
                            <span class="renewal-option-label">January 1, 2026</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Repeatable Carriers Alert -->
        <div class="repeatable-carriers-section">
            <div class="repeatable-carriers-title">
                üö® Repeatable Carriers Alert
            </div>
            <div id="carrierAlertContainer">
                <!-- Carrier alerts will be populated here -->
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="metrics-grid">
            <div class="metric-card primary">
                <div class="metric-header">
                    <div>
                        <div class="metric-title">Total Tasks</div>
                        <div class="metric-value" id="totalTasks">3,951</div>
                        <div class="metric-subtitle">Active collection tasks</div>
                    </div>
                    <div class="metric-icon primary">üìÑ</div>
                </div>
            </div>
            
            <div class="metric-card success">
                <div class="metric-header">
                    <div>
                        <div class="metric-title">Completion Rate</div>
                        <div class="metric-value" id="completionRate">17.5%</div>
                        <div class="metric-subtitle" id="completionSubtitle">693 completed tasks</div>
                    </div>
                    <div class="metric-icon success">‚úÖ</div>
                </div>
            </div>
            
            <div class="metric-card secondary">
                <div class="metric-header">
                    <div>
                        <div class="metric-title">Active Brokers</div>
                        <div class="metric-value" id="activeBrokers">12</div>
                        <div class="metric-subtitle">Partner organizations</div>
                    </div>
                    <div class="metric-icon secondary">üë•</div>
                </div>
            </div>
            
            <div class="metric-card purple">
                <div class="metric-header">
                    <div>
                        <div class="metric-title">Eligible Lives</div>
                        <div class="metric-value" id="eligibleLives">1.22M</div>
                        <div class="metric-subtitle">Total covered individuals</div>
                    </div>
                    <div class="metric-icon purple">üè•</div>
                </div>
            </div>
        </div>

        <!-- Key Insights -->
        <div class="insights-section">
            <div class="insights-title">
                ‚ö†Ô∏è Key Insights & Action Items
            </div>
            <div class="insights-grid">
                <div class="insights-column">
                    <h4 style="color: #000099;">‚ö†Ô∏è Priority Actions:</h4>
                    <ul id="priorityInsights">
                        <li>50.2% tasks still "Not Started" - need acceleration</li>
                        <li>242 tasks escalated - require immediate attention</li>
                        <li>Focus on top 3 brokers handling 80% of volume</li>
                        <li>Implement automated follow-up for stalled tasks</li>
                        <li>Review escalation processes for efficiency</li>
                    </ul>
                </div>
                <div class="insights-column">
                    <h4 style="color: #1A7848;">‚úÖ Successes:</h4>
                    <ul id="successInsights">
                        <li>34.3% completion rate (Complete + Broker Provided)</li>
                        <li>Strong engagement with 72 different carriers</li>
                        <li>1.2M+ eligible lives being managed successfully</li>
                        <li>Consistent progress across major brokers</li>
                        <li>Effective collaboration with partner organizations</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Broker Performance -->
        <div class="brokers-section">
            <h2 class="section-title" id="brokerSectionTitle">Broker Performance Analysis</h2>
            <div id="brokerContainer">
                <!-- Broker data will be populated here -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="container">
            <p>Last updated: <span id="currentDate"></span> | Data source: ThreeFlow Workspace</p>
            <div class="threeflow-brand">
                <div class="brand-dot"></div>
                <span style="font-weight: 600; color: #1f2937;">ThreeFlow</span>
            </div>
        </div>
    </div>

    <script>
        // Global data storage
        let csvData = [];
        let processedData = {};
        let selectedRenewalDates = ['all'];
        
        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
        
        // Renewal multi-select functions
        function toggleRenewalDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('renewalDropdown');
            dropdown.classList.toggle('show');
        }
        
        function toggleRenewalOption(event, checkboxId) {
            event.stopPropagation();
            const checkbox = document.getElementById(checkboxId);
            checkbox.checked = !checkbox.checked;
            handleRenewalChange();
        }
        
        function handleRenewalChange() {
            const allCheckbox = document.getElementById('all-renewals');
            const otherCheckboxes = document.querySelectorAll('#renewalDropdown input[type="checkbox"]:not(#all-renewals)');
            
            // If "All" was just checked, uncheck others
            if (allCheckbox.checked) {
                otherCheckboxes.forEach(cb => cb.checked = false);
                selectedRenewalDates = ['all'];
            } else {
                // Get selected specific dates
                selectedRenewalDates = Array.from(otherCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                // If no specific dates selected, check "All"
                if (selectedRenewalDates.length === 0) {
                    allCheckbox.checked = true;
                    selectedRenewalDates = ['all'];
                }
            }
            
            updateRenewalButtonText();
            applyFilters();
        }
        
        function updateRenewalButtonText() {
            const buttonText = document.getElementById('renewalButtonText');
            if (selectedRenewalDates.includes('all')) {
                buttonText.textContent = 'All Renewal Dates';
            } else {
                const dateNames = selectedRenewalDates.map(date => {
                    switch(date) {
                        case 'october-1-2025': return 'Oct 1, 2025';
                        case 'november-1-2025': return 'Nov 1, 2025';
                        case 'december-1-2025': return 'Dec 1, 2025';
                        case 'january-1-2026': return 'Jan 1, 2026';
                        default: return date;
                    }
                });
                buttonText.textContent = dateNames.join(', ');
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const multiSelect = document.querySelector('.renewal-multi-select');
            const dropdown = document.getElementById('renewalDropdown');
            if (!multiSelect.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // CSV Processing Functions
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            
            return data;
        }
        
        function processCSVData(data) {
            const brokerGroups = {};
            const overallStats = {
                totalTasks: data.length,
                completed: 0,
                brokers: new Set(),
                carriers: new Set(),
                totalLives: 0,
                collectionStatus: {},
                renewalStatus: {}
            };
            
            data.forEach(row => {
                const broker = row['Broker (drop down)'] || 'Unknown';
                const carrier = row['Carrier (short text)'] || 'Unknown';
                const collectionStatus = row['Collection Status (drop down)'] || 'Unknown';
                const renewalStatus = row['Renewal Doc Status (drop down)'] || 'Unknown';
                const eligibleLives = parseInt(row['Eligible Lives (number)']) || 0;
                
                // Track overall stats
                overallStats.brokers.add(broker);
                overallStats.carriers.add(carrier);
                overallStats.totalLives += eligibleLives;
                overallStats.collectionStatus[collectionStatus] = (overallStats.collectionStatus[collectionStatus] || 0) + 1;
                overallStats.renewalStatus[renewalStatus] = (overallStats.renewalStatus[renewalStatus] || 0) + 1;
                
                if (collectionStatus === 'Complete') {
                    overallStats.completed++;
                }
                
                // Group by broker
                if (!brokerGroups[broker]) {
                    brokerGroups[broker] = {
                        name: broker,
                        tasks: [],
                        totalTasks: 0,
                        completed: 0,
                        pending: 0,
                        escalated: 0,
                        brokerProvided: 0,
                        notStarted: 0,
                        carriers: new Set(),
                        totalLives: 0
                    };
                }
                
                brokerGroups[broker].tasks.push(row);
                brokerGroups[broker].totalTasks++;
                brokerGroups[broker].carriers.add(carrier);
                brokerGroups[broker].totalLives += eligibleLives;
                
                switch(collectionStatus) {
                    case 'Complete': brokerGroups[broker].completed++; break;
                    case 'Pending': brokerGroups[broker].pending++; break;
                    case 'Escalated': brokerGroups[broker].escalated++; break;
                    case 'Broker Provided': brokerGroups[broker].brokerProvided++; break;
                    case 'Not started': brokerGroups[broker].notStarted++; break;
                }
            });
            
            return {
                brokers: Object.values(brokerGroups),
                overall: {
                    ...overallStats,
                    brokers: overallStats.brokers.size,
                    carriers: overallStats.carriers.size,
                    completionRate: (overallStats.completed / overallStats.totalTasks * 100).toFixed(1)
                }
            };
        }
        
        function updateUI() {
            updateMetrics();
            updateBrokerDropdown();
            updateBrokerSection();
            updateInsights();
            updateRepeatableCarriersAlert();
        }
        
        function updateMetrics() {
            if (!processedData.overall) return;
            
            const stats = processedData.overall;
            document.getElementById('totalTasks').textContent = stats.totalTasks.toLocaleString();
            document.getElementById('completionRate').textContent = stats.completionRate + '%';
            document.getElementById('activeBrokers').textContent = stats.brokers;
            document.getElementById('eligibleLives').textContent = formatNumber(stats.totalLives);
            document.getElementById('completionSubtitle').textContent = stats.completed + ' completed tasks';
        }
        
        function updateBrokerDropdown() {
            const select = document.getElementById('brokerSelect');
            select.innerHTML = '<option value="all">All Brokers</option>';
            
            processedData.brokers.forEach(broker => {
                const option = document.createElement('option');
                option.value = broker.name;
                option.textContent = broker.name;
                select.appendChild(option);
            });
        }
        
        function updateBrokerSection() {
            const container = document.getElementById('brokerContainer');
            container.innerHTML = '';
            
            processedData.brokers
                .sort((a, b) => b.totalTasks - a.totalTasks)
                .forEach((broker, index) => {
                    const completionRate = (broker.completed / broker.totalTasks * 100).toFixed(1);
                    const rateClass = completionRate > 20 ? 'high' : completionRate > 15 ? 'medium' : 'low';
                    
                    const brokerDiv = document.createElement('div');
                    brokerDiv.className = 'broker-item';
                    brokerDiv.innerHTML = `
                        <div class="broker-header" onclick="toggleBroker('broker${index}')">
                            <div class="broker-info">
                                <h3>${broker.name}</h3>
                                <div class="broker-stats">${broker.totalTasks} tasks ‚Ä¢ ${broker.carriers.size} carriers ‚Ä¢ ${formatNumber(broker.totalLives)} lives</div>
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${completionRate}%"></div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="completion-rate ${rateClass}">${completionRate}%</div>
                                <span class="chevron" id="chevron${index}">‚ñ∂</span>
                            </div>
                        </div>
                        <div class="broker-details" id="details${index}">
                            <div class="details-grid">
                                <div class="detail-item complete">
                                    <div class="detail-value">${broker.completed}</div>
                                    <div class="detail-label">Complete</div>
                                </div>
                                <div class="detail-item pending">
                                    <div class="detail-value">${broker.pending}</div>
                                    <div class="detail-label">Pending</div>
                                </div>
                                <div class="detail-item escalated">
                                    <div class="detail-value">${broker.escalated}</div>
                                    <div class="detail-label">Escalated</div>
                                </div>
                                <div class="detail-item carriers">
                                    <div class="detail-value">${broker.carriers.size}</div>
                                    <div class="detail-label">Carriers</div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(brokerDiv);
                });
        }
        
        function updateRepeatableCarriersAlert() {
            const container = document.getElementById('carrierAlertContainer');
            const repeatableCarriers = ['Principal', 'Unum', 'MetLife', 'Lincoln', 'Hartford', 'Guardian', 'Moo', 'Equitable', 'One America'];
            
            // Find issues with repeatable carriers
            const carrierIssues = {};
            
            // Initialize tracking for all repeatable carriers
            repeatableCarriers.forEach(carrier => {
                carrierIssues[carrier] = {
                    notStarted: 0,
                    escalated: 0,
                    total: 0,
                    tasks: []
                };
            });
            
            // Analyze current data
            if (csvData && csvData.length > 0) {
                csvData.forEach(row => {
                    const carrier = row['Carrier (short text)'] || '';
                    const collectionStatus = row['Collection Status (drop down)'] || '';
                    
                    // Check if this is a repeatable carrier (case insensitive partial match)
                    const matchedCarrier = repeatableCarriers.find(repCarrier => 
                        carrier.toLowerCase().includes(repCarrier.toLowerCase()) ||
                        repCarrier.toLowerCase().includes(carrier.toLowerCase())
                    );
                    
                    if (matchedCarrier) {
                        carrierIssues[matchedCarrier].total++;
                        carrierIssues[matchedCarrier].tasks.push(row);
                        
                        if (collectionStatus === 'Not started') {
                            carrierIssues[matchedCarrier].notStarted++;
                        } else if (collectionStatus === 'Escalated') {
                            carrierIssues[matchedCarrier].escalated++;
                        }
                    }
                });
            }
            
            // Check if any carriers have issues
            const carriersWithIssues = Object.entries(carrierIssues).filter(([carrier, data]) => 
                data.notStarted > 0 || data.escalated > 0
            );
            
            if (carriersWithIssues.length === 0) {
                container.innerHTML = `
                    <div class="no-issues">
                        ‚úÖ All Repeatable Carriers Clear!<br>
                        <span style="font-size: 0.9rem; font-weight: normal;">No "Not Started" or "Escalated" tasks found for Principal, Unum, MetLife, Lincoln, Hartford, Guardian, Moo, Equitable, or One America</span>
                    </div>
                `;
                return;
            }
            
            // Create alert grid
            container.innerHTML = '<div class="carrier-alert-grid" id="carrierAlertGrid"></div>';
            const alertGrid = document.getElementById('carrierAlertGrid');
            
            carriersWithIssues.forEach(([carrier, data]) => {
                const hasEscalated = data.escalated > 0;
                const hasNotStarted = data.notStarted > 0;
                const alertClass = hasEscalated ? 'escalated' : 'not-started';
                
                let issueText = '';
                if (hasEscalated && hasNotStarted) {
                    issueText = `${data.escalated} escalated, ${data.notStarted} not started tasks`;
                } else if (hasEscalated) {
                    issueText = `${data.escalated} escalated tasks need attention`;
                } else {
                    issueText = `${data.notStarted} tasks haven't been started`;
                }
                
                const alertItem = document.createElement('div');
                alertItem.className = `carrier-alert-item ${alertClass}`;
                alertItem.innerHTML = `
                    <div class="carrier-name">${carrier}</div>
                    <div class="carrier-issues">${issueText}</div>
                    <div class="carrier-details">
                        ${hasEscalated ? `<span class="issue-count escalated">${data.escalated} Escalated</span>` : ''}
                        ${hasNotStarted ? `<span class="issue-count not-started">${data.notStarted} Not Started</span>` : ''}
                        <span style="color: #6b7280; font-size: 0.8rem;">Total: ${data.total} tasks</span>
                    </div>
                `;
                alertGrid.appendChild(alertItem);
            });
        }
        
        function updateInsights() {
            const priorityList = document.getElementById('priorityInsights');
            const successList = document.getElementById('successInsights');
            
            if (!processedData.overall) return;
            
            const stats = processedData.overall;
            const notStartedPercent = ((stats.collectionStatus['Not started'] || 0) / stats.totalTasks * 100).toFixed(1);
            const escalatedCount = stats.collectionStatus['Escalated'] || 0;
            
            priorityList.innerHTML = `
                <li>${notStartedPercent}% tasks still "Not Started" - need acceleration</li>
                <li>${escalatedCount} tasks escalated - require immediate attention</li>
                <li>Focus on top 3 brokers handling majority of volume</li>
                <li>Implement automated follow-up for stalled tasks</li>
                <li>Review escalation processes for efficiency</li>
            `;
            
            const completedAndProvided = (stats.collectionStatus['Complete'] || 0) + (stats.collectionStatus['Broker Provided'] || 0);
            const totalCompletionRate = (completedAndProvided / stats.totalTasks * 100).toFixed(1);
            
            successList.innerHTML = `
                <li>${totalCompletionRate}% completion rate (Complete + Broker Provided)</li>
                <li>Strong engagement with ${stats.carriers} different carriers</li>
                <li>${formatNumber(stats.totalLives)} eligible lives being managed</li>
                <li>Consistent progress across ${stats.brokers} broker partners</li>
                <li>Effective collaboration with partner organizations</li>
            `;
        }
        
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return Math.round(num / 1000) + 'K';
            } else {
                return num.toString();
            }
        }
        
        // Toggle broker details
        function toggleBroker(brokerId) {
            const details = document.getElementById('details' + brokerId.replace('broker', ''));
            const chevron = document.getElementById('chevron' + brokerId.replace('broker', ''));
            
            if (details && chevron) {
                details.classList.toggle('expanded');
                chevron.classList.toggle('expanded');
            }
        }
        
        // CSV Upload functionality
        function uploadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('Please select a CSV file first.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    csvData = parseCSV(e.target.result);
                    processedData = processCSVData(csvData);
                    updateUI();
                    showStatus(`Successfully loaded ${csvData.length} records from CSV!`, 'success');
                } catch (error) {
                    showStatus('Error processing CSV: ' + error.message, 'error');
                    console.error('CSV processing error:', error);
                }
            };
            reader.readAsText(file);
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.textContent = message;
            statusDiv.className = `upload-status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // Filter functionality
        function applyFilters() {
            const selectedBroker = document.getElementById('brokerSelect').value;
            
            let filteredData = csvData;
            
            // Filter by broker
            if (selectedBroker !== 'all') {
                filteredData = filteredData.filter(row => row['Broker (drop down)'] === selectedBroker);
            }
            
            // Filter by renewal dates
            if (!selectedRenewalDates.includes('all')) {
                filteredData = filteredData.filter(row => {
                    const renewalDate = row['Renewal date (date)'] || '';
                    return selectedRenewalDates.some(selectedDate => {
                        switch(selectedDate) {
                            case 'october-1-2025':
                                return renewalDate.toLowerCase().includes('october') && renewalDate.includes('1') && renewalDate.includes('2025');
                            case 'november-1-2025':
                                return renewalDate.toLowerCase().includes('november') && renewalDate.includes('1') && renewalDate.includes('2025');
                            case 'december-1-2025':
                                return renewalDate.toLowerCase().includes('december') && renewalDate.includes('1') && renewalDate.includes('2025');
                            case 'january-1-2026':
                                return renewalDate.toLowerCase().includes('january') && renewalDate.includes('1') && renewalDate.includes('2026');
                            default:
                                return false;
                        }
                    });
                });
            }
            
            // Reprocess with filtered data
            const filteredProcessedData = processCSVData(filteredData);
            processedData = filteredProcessedData;
            
            // Update UI
            updateMetrics();
            updateBrokerSection();
            updateInsights();
            updateRepeatableCarriersAlert();
            
            // Update section title
            const sectionTitle = document.getElementById('brokerSectionTitle');
            if (selectedBroker === 'all') {
                sectionTitle.textContent = 'Broker Performance Analysis';
            } else {
                sectionTitle.textContent = `${selectedBroker} - Detailed Analysis`;
            }
            
            // Show filter status
            let filterStatus = '';
            if (selectedBroker !== 'all') {
                filterStatus += `Broker: ${selectedBroker}`;
            }
            if (!selectedRenewalDates.includes('all')) {
                const renewalText = selectedRenewalDates.map(date => {
                    switch(date) {
                        case 'october-1-2025': return 'Oct 1, 2025';
                        case 'november-1-2025': return 'Nov 1, 2025';
                        case 'december-1-2025': return 'Dec 1, 2025';
                        case 'january-1-2026': return 'Jan 1, 2026';
                        default: return date;
                    }
                }).join(', ');
                filterStatus += (filterStatus ? ' | ' : '') + `Renewals: ${renewalText}`;
            }
            
            if (filterStatus) {
                showStatus(`Filtered: ${filterStatus} (${filteredData.length} tasks)`, 'success');
            }
        }
        
        // Initialize with sample data
        function initializeSampleData() {
            const sampleData = [];
            const brokers = ["McGohan Brabender", "The Baldwin Group - Southwest", "McGriff Insurance - Blue Ridge", "Marsh McLennan - Virginia", "CAC Agency", "Marsh McLennan - Florida"];
            const carriers = ["Standard", "Blue Cross Blue Shield", "Equitable", "Guardian", "Mutual Of Omaha", "Delta Dental", "Principal", "Unum", "MetLife", "Lincoln Financial", "The Hartford", "Moo", "One America"];
            const statuses = ["Not started", "Pending", "Escalated", "Complete", "Broker Provided"];
            const renewalDates = [
                "Tuesday, October 1st 2025",
                "Saturday, November 1st 2025", 
                "Monday, December 1st 2025",
                "Wednesday, January 1st 2026"
            ];
            
            for (let i = 0; i < 1000; i++) {
                // Increase chance of issues for repeatable carriers to demonstrate the feature
                const carrier = carriers[Math.floor(Math.random() * carriers.length)];
                const isRepeatableCarrier = ['Principal', 'Unum', 'MetLife', 'Lincoln Financial', 'The Hartford', 'Guardian', 'Moo', 'Equitable', 'One America'].includes(carrier);
                
                let status;
                if (isRepeatableCarrier && Math.random() < 0.3) {
                    // 30% chance of issues for repeatable carriers (for demo purposes)
                    status = Math.random() < 0.5 ? 'Escalated' : 'Not started';
                } else {
                    status = statuses[Math.floor(Math.random() * statuses.length)];
                }
                
                sampleData.push({
                    "Task ID": `task_${i}`,
                    "Task Name": `Sample Task ${i}`,
                    "Broker (drop down)": brokers[Math.floor(Math.random() * brokers.length)],
                    "Carrier (short text)": carrier,
                    "Collection Status (drop down)": status,
                    "Renewal Doc Status (drop down)": Math.random() > 0.7 ? "Renewal Collected" : "Renewal Not Collected",
                    "Renewal date (date)": renewalDates[Math.floor(Math.random() * renewalDates.length)],
                    "Eligible Lives (number)": Math.floor(Math.random() * 500) + 10
                });
            }
            
            csvData = sampleData;
            processedData = processCSVData(csvData);
            updateUI();
        }
        
        // Event listeners
        document.getElementById('brokerSelect').addEventListener('change', applyFilters);
        
        // Initialize on page load
        window.addEventListener('load', function() {
            initializeSampleData();
            
            // Animate progress bars
            setTimeout(() => {
                const progressBars = document.querySelectorAll('.progress-fill');
                progressBars.forEach(bar => {
                    const width = bar.style.width;
                    bar.style.width = '0%';
                    setTimeout(() => {
                        bar.style.width = width;
                    }, 100);
                });
            }, 500);
        });
        
        console.log('ThreeFlow Dashboard loaded successfully!');
    </script>
</body>
</html>
